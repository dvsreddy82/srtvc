rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }
    
    function hasAnyRole(roles) {
      return isAuthenticated() && request.auth.token.role in roles;
    }
    
    // Users: can read/write their own profile, admins can read all
    match /users/{userId} {
      allow read: if isOwner(userId) || hasRole('admin');
      allow write: if isOwner(userId) || hasRole('admin');
    }
    
    // Pets: owners can read/write their pets, staff can read assigned pets
    match /pets/{petId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        hasAnyRole(['staff', 'manager', 'admin', 'veterinarian'])
      );
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        hasAnyRole(['staff', 'manager', 'admin'])
      );
      allow delete: if isOwner(resource.data.ownerId) || hasRole('admin');
    }
    
    // Medical Records: owners can read, vets can write (with consent)
    match /medical_records/{recordId} {
      allow read: if isAuthenticated() && (
        resource.data.petOwnerId == request.auth.uid ||
        hasRole('veterinarian') ||
        hasRole('admin')
      );
      allow write: if isAuthenticated() && (
        hasRole('veterinarian') ||
        hasRole('admin')
      );
    }
    
    // Vaccines: similar to medical records
    match /vaccines/{vaccineId} {
      allow read: if isAuthenticated() && (
        resource.data.petId != null // Check pet owner
      );
      allow write: if isAuthenticated() && (
        hasRole('veterinarian') ||
        hasRole('admin')
      );
    }
    
    // Bookings: owners can read their bookings, staff can update
    match /bookings/{bookingId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['staff', 'manager', 'admin'])
      );
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['staff', 'manager', 'admin'])
      );
      allow delete: if isOwner(resource.data.userId) || hasRole('admin');
    }
    
    // Booking Notes: staff and owners can read, staff can write
    match /booking_notes/{noteId} {
      allow read: if isAuthenticated() && (
        resource.data.bookingId != null // Will need to check booking owner
      );
      allow write: if isAuthenticated() && hasAnyRole(['staff', 'manager', 'admin']);
    }
    
    // Stay Updates: owners can read, staff can write
    match /stay_updates/{updateId} {
      allow read: if isAuthenticated() && (
        resource.data.bookingId != null // Will need to check booking owner
      );
      allow write: if isAuthenticated() && hasAnyRole(['staff', 'manager', 'admin']);
    }
    
    // Invoices: owners can read their invoices
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['staff', 'manager', 'admin'])
      );
      allow write: if hasAnyRole(['manager', 'admin']); // Only managers/admins can create invoices
    }
    
    // Reviews: public read, authenticated create
    match /reviews/{reviewId} {
      allow read: if true; // Public reviews
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if false; // Immutable
      allow delete: if hasRole('admin');
    }
    
    // Kennels: public read, managers/admins can write
    match /kennels/{kennelId} {
      allow read: if true; // Public kennel listings
      allow write: if isAuthenticated() && hasAnyRole(['manager', 'admin']);
    }
    
    // Kennel Runs: public read, managers/admins can write
    match /kennel_runs/{runId} {
      allow read: if true; // Public for availability checks
      allow write: if isAuthenticated() && hasAnyRole(['manager', 'admin']);
    }
    
    // Pet Consents: owners can read/write, vets can read
    match /pet_consents/{consentId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        hasRole('veterinarian') ||
        hasRole('admin')
      );
      allow write: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        hasRole('admin')
      );
    }
    
    // Staff Assignments: staff can read their own, managers/admins can write
    match /staff_assignments/{assignmentId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        hasAnyRole(['manager', 'admin'])
      );
      allow write: if isAuthenticated() && hasAnyRole(['manager', 'admin']);
    }
    
    // Master Data: public read, admin write
    match /master_data/{document=**} {
      allow read: if true; // Public master data (breeds, vaccine types)
      allow write: if isAuthenticated() && hasRole('admin');
    }
    
    // Admin Audit Logs: admin only
    match /admin_audit_logs/{logId} {
      allow read: if isAuthenticated() && hasRole('admin');
      allow write: if false; // Only Cloud Functions can write
    }
    
    // System Metrics: admin only
    match /system_metrics/{metricId} {
      allow read: if isAuthenticated() && hasRole('admin');
      allow write: if false; // Only Cloud Functions can write
    }
  }
}
